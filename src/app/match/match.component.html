<section class="content-match">
  <div class="top-bar">
    <app-back-button [back]="true" ariaLabel="Voltar" label="← VOLTAR" />
  </div>

  <!-- SELEÇÃO E RESUMO (antes de iniciar o jogo) -->
  @if (!gameStarted()) {
    <header class="match-header">
      <h2 class="match-title">Match • {{ communityName() || ('Comunidade #' + communityId()) }}</h2>
      <p class="match-sub">Players da comunidade · <span class="badge-count">{{ players().length }}</span></p>
    </header>

    <!-- Team chooser blocks -->
    <div class="teams-select">
      <button class="team-card" [class.active]="selectedTeam() === 'A'" (click)="chooseTeam('A')" type="button">
        <h1 class="team-title">Time A</h1>
        <div class="team-count">{{ teamA().length }} / {{ maxPerTeam }}</div>
      </button>
      <button class="team-card" [class.active]="selectedTeam() === 'B'" (click)="chooseTeam('B')" type="button">
        <h1 class="team-title">Time B</h1>
        <div class="team-count">{{ teamB().length }} / {{ maxPerTeam }}</div>
      </button>
    </div>

    @if (!selectedTeam() && !allSelected()) {
      <p class="hint">Selecione um time para começar a escolher os jogadores.</p>
    }

    <!-- Players list for current selection -->
    @if (!allSelected()) {
      <div class="players-grid">
        @if (players().length === 0) {
          <p class="empty">Nenhum jogador encontrado para esta comunidade.</p>
        } @else {
          @for (p of players(); track $index) {
            <article class="player-card"
                     [class.selected]="isSelectedForCurrent(p)"
                     [class.disabled]="!canSelect(p) && !isSelectedForCurrent(p)"
                     (click)="togglePlayer(p)"
                     tabindex="0">
              <div class="avatar-wrap">
                <img class="avatar" [src]="p.playerImage" [alt]="p.playerName" loading="lazy" />
                <span class="lvl-chip" title="Nível">LV {{ p.level }}</span>
              </div>
              <div class="player-info">
                <h3 class="player-name">{{ p.playerName }}</h3>
                <ul class="stats">
                  <li><span class="stat-label">Idade</span><span class="stat-value">{{ p.age }}</span></li>
                  <li><span class="stat-label">Pontos</span><span class="stat-value">{{ p.totalPoints }}</span></li>
                </ul>
              </div>
            </article>
          }
        }
      </div>
    }

    <!-- Summary when both teams are complete -->
    @if (allSelected()) {
      <section class="summary">
        <h3>Resumo dos Times</h3>
        <div class="teams-summary">
          <div class="team-summary">
            <h4>Time A</h4>
            <ul>
              @for (p of teamA(); track $index) {
                <li>{{ p.playerName }} · LV {{ p.level }} · {{ p.totalPoints }} pts</li>
              }
            </ul>
          </div>
          <div class="team-summary">
            <h4>Time B</h4>
            <ul>
              @for (p of teamB(); track $index) {
                <li>{{ p.playerName }} · LV {{ p.level }} · {{ p.totalPoints }} pts</li>
              }
            </ul>
          </div>
        </div>
        <div class="actions">
          <button class="reset-btn" type="button" (click)="resetSelection()">Refazer seleção</button>
          <button class="start-btn" type="button" (click)="startGame()">Iniciar Jogo</button>
        </div>
      </section>
    }
  }

  <!-- TELA DE PARTIDA (tema street) -->
  @if (gameStarted()) {
    <section class="game-screen">
      <header class="game-header">
        <h2 class="game-title">Arena Match • {{ communityName() || ('Comunidade #' + communityId()) }}</h2>
        @if (winner() === null) {
          <div class="timer">
            <button class="mute-btn pause-btn" type="button" (click)="toggleNarrator()">{{ narratorOn() ? 'Mutar Narrador' : 'Ativar Narrador' }}</button>
            <button class="speak-score-btn pause-btn" type="button" (click)="speakCurrentScore()">Falar Placar</button>
            <button class="pause-btn" type="button" (click)="toggleTimer()">{{ running() ? 'Pausar' : 'Continuar' }}</button>
          </div>
        }
      </header>

      <!-- Jumbotron NBA-style scoreboard -->
      <div class="jumbotron" [class.pulse-a]="scoreboardPulse() && lastScoredTeam() === 'A'" [class.pulse-b]="scoreboardPulse() && lastScoredTeam() === 'B'" role="region" aria-live="polite" aria-label="Placar do jogo">
        <div class="team-panel left">
          <div class="team-name">
            <span class="name">Time A</span>
            <span class="color-bar a" aria-hidden="true"></span>
          </div>
          <div class="team-score" aria-label="Placar Time A">{{ scoreA() }}</div>
        </div>
        <div class="center-panel">
          <div class="arena-brand" aria-hidden="true">TEMPO</div>
          <div class="center-time">{{ formatTime(timeLeft()) }}</div>
        </div>
        <div class="team-panel right">
          <div class="team-name">
            <span class="name">Time B</span>
            <span class="color-bar b" aria-hidden="true"></span>
          </div>
          <div class="team-score" aria-label="Placar Time B">{{ scoreB() }}</div>
        </div>

        <!-- Confetti burst -->
        @if (confettiSide() === 'A') { <div class="confetti confetti-left" aria-hidden="true"></div> }
        @if (confettiSide() === 'B') { <div class="confetti confetti-right" aria-hidden="true"></div> }
      </div>

      <!-- Mobile Tabs for team columns -->
      <nav class="mobile-tabs" role="tablist" aria-label="Alternar times">
        <button role="tab" [attr.aria-selected]="mobileTab() === 'A'" (click)="mobileTab.set('A')" class="tab" [class.active]="mobileTab() === 'A'">Time A</button>
        <button role="tab" [attr.aria-selected]="mobileTab() === 'B'" (click)="mobileTab.set('B')" class="tab" [class.active]="mobileTab() === 'B'">Time B</button>
      </nav>

      <div class="players-columns" [attr.data-tab]="mobileTab()">
        <app-team-players-column
          class="col-a"
          title="Jogadores A"
          [teamId]="'A'"
          [players]="teamA()"
          [points]="playerPointsRecord()"
          [topNames]="topNamesSet()"
          [bottomNames]="bottomNamesSet()"
          [disabled]="winner() !== null"
          (adjust)="openAdjustPoints($event.team, $event.player, $event.points)"
        />
        <app-team-players-column
          class="col-b"
          title="Jogadores B"
          [teamId]="'B'"
          [players]="teamB()"
          [points]="playerPointsRecord()"
          [topNames]="topNamesSet()"
          [bottomNames]="bottomNamesSet()"
          [disabled]="winner() !== null"
          (adjust)="openAdjustPoints($event.team, $event.player, $event.points)"
        />
      </div>

      @if (winner() !== null) {
        <div class="game-result">
          @if (winner() === 'Empate') {
            <p>Fim de jogo: Empate!</p>
          } @else {
            <p>Fim de jogo: Time {{ winner() }} venceu!</p>
          }
        </div>
        <div class="end-actions">
          <button class="stats-btn" type="button" (click)="openStats()">Ver Estatísticas</button>
          <button class="reset-btn" type="button" (click)="resetSelection()">Nova Partida</button>
        </div>
      }

      <!-- Modal Estatísticas -->
      @if (statsOpen()) {
        <div class="modal-overlay" (click)="closeStats()">
          <div class="modal-card stats-modal" (click)="$event.stopPropagation()">
            <h3>Estatísticas da Partida</h3>
            <ul class="stat-list">
              <li>
                <strong>MVP:</strong>
                @if (mvpPlayer()) { {{ mvpPlayer()!.playerName }} · {{ getPlayerMatchPoints(mvpPlayer()!) }} pts } @else { — }
              </li>
              <li>
                <strong>Maior Pontuador:</strong>
                @if (topScorerPlayer()) { {{ topScorerPlayer()!.playerName }} · {{ getPlayerMatchPoints(topScorerPlayer()!) }} pts } @else { — }
              </li>
            </ul>

            @if (bestPlayer()) {
              <app-card-qualificacao
                [player]="bestPlayer()!"
                [teamPlayers]="teamFor(bestPlayer()!)"
                [pointsRecord]="playerPointsRecord()"
                [animated]="true"
              />
            }

            <button type="button" class="btn-cancel" (click)="closeStats()">Fechar</button>
          </div>
        </div>
      }

      <!-- Modal para somar/diminuir pontos -->
      @if (modalOpen()) {
        <div class="modal-overlay" (click)="closeModal()">
          <div class="modal-card" (click)="$event.stopPropagation()">
            <h3>Ajustar Pontos</h3>
            @if (pendingAction()) {
              <p>
                Time {{ pendingAction()!.team }} •
                {{ pendingAction()!.player.playerName }}<br />
                Pontuação selecionada: <strong>{{ pendingAction()!.points }}</strong>
              </p>
            }
            <div class="modal-actions">
              <button type="button" class="btn-sub" (click)="confirmAdjust('sub')">Diminuir</button>
              <button type="button" class="btn-sum" (click)="confirmAdjust('sum')">Somar</button>
            </div>
            <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
          </div>
        </div>
      }
    </section>
  }
</section>
