<section class="content-match">
  <div class="top-bar">
    <app-back-button [back]="true" ariaLabel="Voltar" label="← VOLTAR" />
  </div>

  <!-- SELEÇÃO E RESUMO (antes de iniciar o jogo) -->
  @if (!gameStarted()) {
    <header class="match-header">
      <h2 class="match-title">Match • {{ communityName() || ('Comunidade #' + communityId()) }}</h2>
      <p class="match-sub">Players da comunidade · <span class="badge-count">{{ players().length }}</span></p>
    </header>

    <!-- Team chooser blocks -->
    <div class="teams-select">
      <button class="team-card" [class.active]="selectedTeam() === 'A'" (click)="chooseTeam('A')" type="button">
        <div class="team-title">Time A</div>
        <div class="team-count">{{ teamA().length }} / {{ maxPerTeam }}</div>
      </button>
      <button class="team-card" [class.active]="selectedTeam() === 'B'" (click)="chooseTeam('B')" type="button">
        <div class="team-title">Time B</div>
        <div class="team-count">{{ teamB().length }} / {{ maxPerTeam }}</div>
      </button>
    </div>

    @if (!selectedTeam() && !allSelected()) {
      <p class="hint">Selecione um time para começar a escolher os jogadores.</p>
    }

    <!-- Players list for current selection -->
    @if (!allSelected()) {
      <div class="players-grid">
        @if (players().length === 0) {
          <p class="empty">Nenhum jogador encontrado para esta comunidade.</p>
        } @else {
          @for (p of players(); track $index) {
            <article class="player-card"
                     [class.selected]="isSelectedForCurrent(p)"
                     [class.disabled]="!canSelect(p) && !isSelectedForCurrent(p)"
                     (click)="togglePlayer(p)"
                     tabindex="0">
              <div class="avatar-wrap">
                <img class="avatar" [src]="p.playerImage" [alt]="p.playerName" loading="lazy" />
                <span class="lvl-chip" title="Nível">LV {{ p.level }}</span>
              </div>
              <div class="player-info">
                <h3 class="player-name">{{ p.playerName }}</h3>
                <ul class="stats">
                  <li><span class="stat-label">Idade</span><span class="stat-value">{{ p.age }}</span></li>
                  <li><span class="stat-label">Pontos</span><span class="stat-value">{{ p.totalPoints }}</span></li>
                </ul>
              </div>
            </article>
          }
        }
      </div>
    }

    <!-- Summary when both teams are complete -->
    @if (allSelected()) {
      <section class="summary">
        <h3>Resumo dos Times</h3>
        <div class="teams-summary">
          <div class="team-summary">
            <h4>Time A</h4>
            <ul>
              @for (p of teamA(); track $index) {
                <li>{{ p.playerName }} · LV {{ p.level }} · {{ p.totalPoints }} pts</li>
              }
            </ul>
          </div>
          <div class="team-summary">
            <h4>Time B</h4>
            <ul>
              @for (p of teamB(); track $index) {
                <li>{{ p.playerName }} · LV {{ p.level }} · {{ p.totalPoints }} pts</li>
              }
            </ul>
          </div>
        </div>
        <div class="actions">
          <button class="reset-btn" type="button" (click)="resetSelection()">Refazer seleção</button>
          <button class="start-btn" type="button" (click)="startGame()">Iniciar Jogo</button>
        </div>
      </section>
    }
  }

  <!-- TELA DE PARTIDA (tema street) -->
  @if (gameStarted()) {
    <section class="game-screen">
      <header class="game-header">
        <h2 class="game-title">Street Game • {{ communityName() || ('Comunidade #' + communityId()) }}</h2>
        <div class="timer">
          <span class="time-display">{{ formatTime(timeLeft()) }}</span>
          <button class="pause-btn" type="button" (click)="toggleTimer()">{{ running() ? 'Pausar' : 'Continuar' }}</button>
        </div>
      </header>

      <div class="scoreboard">
        <div class="score team-a">
          <div class="label">Time A</div>
          <div class="value">{{ scoreA() }}</div>
        </div>
        <div class="score team-b">
          <div class="label">Time B</div>
          <div class="value">{{ scoreB() }}</div>
        </div>
      </div>

      <div class="players-columns">
        <div class="team-column team-a-col">
          <h3>Jogadores A</h3>
          <ul>
            @for (p of teamA(); track $index) {
              <li class="player-row">
                <div class="info">
                  <img class="avatar-sm" [src]="p.playerImage" [alt]="p.playerName" />
                  <span class="name">{{ p.playerName }}</span>
                  <span class="match-pts">{{ getPlayerMatchPoints(p) }} pts</span>
                </div>
                <div class="actions">
                  <button type="button" (click)="openAdjustPoints('A', p, 1)" [disabled]="winner() !== null">P1</button>
                  <button type="button" (click)="openAdjustPoints('A', p, 2)" [disabled]="winner() !== null">P2</button>
                  <button type="button" (click)="openAdjustPoints('A', p, 3)" [disabled]="winner() !== null">P3</button>
                </div>
              </li>
            }
          </ul>
        </div>
        <div class="team-column team-b-col">
          <h3>Jogadores B</h3>
          <ul>
            @for (p of teamB(); track $index) {
              <li class="player-row">
                <div class="info">
                  <img class="avatar-sm" [src]="p.playerImage" [alt]="p.playerName" />
                  <span class="name">{{ p.playerName }}</span>
                  <span class="match-pts">{{ getPlayerMatchPoints(p) }} pts</span>
                </div>
                <div class="actions">
                  <button type="button" (click)="openAdjustPoints('B', p, 1)" [disabled]="winner() !== null">P1</button>
                  <button type="button" (click)="openAdjustPoints('B', p, 2)" [disabled]="winner() !== null">P2</button>
                  <button type="button" (click)="openAdjustPoints('B', p, 3)" [disabled]="winner() !== null">P3</button>
                </div>
              </li>
            }
          </ul>
        </div>
      </div>

      @if (winner() !== null) {
        <div class="game-result">
          @if (winner() === 'Empate') {
            <p>Fim de jogo: Empate!</p>
          } @else {
            <p>Fim de jogo: Time {{ winner() }} venceu!</p>
          }
        </div>
      }

      <!-- Modal para somar/diminuir pontos -->
      @if (modalOpen()) {
        <div class="modal-overlay" (click)="closeModal()">
          <div class="modal-card" (click)="$event.stopPropagation()">
            <h3>Ajustar Pontos</h3>
            @if (pendingAction()) {
              <p>
                Time {{ pendingAction()!.team }} •
                {{ pendingAction()!.player.playerName }}<br />
                Pontuação selecionada: <strong>{{ pendingAction()!.points }}</strong>
              </p>
            }
            <div class="modal-actions">
              <button type="button" class="btn-sub" (click)="confirmAdjust('sub')">Diminuir</button>
              <button type="button" class="btn-sum" (click)="confirmAdjust('sum')">Somar</button>
            </div>
            <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
          </div>
        </div>
      }
    </section>
  }
</section>
