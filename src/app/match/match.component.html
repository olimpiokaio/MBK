<section class="content-match">
  <div class="top-bar">
    <app-back-button [back]="true" ariaLabel="Voltar" label="← VOLTAR" />
  </div>

  <!-- SELEÇÃO E RESUMO (antes de iniciar o jogo) -->
  @if (!gameStarted()) {
    <header class="match-header">
      <h2 class="match-title">Partida • {{ communityName() || ('Comunidade #' + communityId()) }}</h2>
      <p class="match-sub">jogadores da comunidade · <span class="badge-count">{{ players().length }}</span></p>
    </header>

    <!-- Team chooser blocks -->
    @if (!allSelected()) {
      <div class="teams-select">
        <button class="team-card" [class.active]="selectedTeam() === 'A'" (click)="chooseTeam('A')" type="button">
          <h1 class="team-title">Time A</h1>
          <div class="team-count">{{ teamA().length }} / {{ maxPerTeam }}</div>
        </button>
        <button class="team-card" [class.active]="selectedTeam() === 'B'" (click)="chooseTeam('B')" type="button">
          <h1 class="team-title">Time B</h1>
          <div class="team-count">{{ teamB().length }} / {{ maxPerTeam }}</div>
        </button>
      </div>
    }

    @if (!selectedTeam() && !allSelected()) {
      <p class="hint">Selecione um time para começar a escolher os jogadores.</p>
    }

    <!-- Players list for current selection -->
    @if (!allSelected()) {
      @if (loadingPlayers()) {
        <app-loading-spinner text="Carregando jogadores…" />
      } @else {
        <div class="players-grid">
          @if (players().length === 0) {
            <p class="empty">Nenhum jogador encontrado para esta comunidade.</p>
          } @else {
            @for (p of players(); track $index) {
              <article class="player-card"
                       [class.selected]="isSelectedForCurrent(p)"
                       [class.disabled]="!canSelect(p) && !isSelectedForCurrent(p)"
                       (click)="togglePlayer(p)"
                       tabindex="0">
                <div class="avatar-wrap">
                  <img class="avatar" [src]="p.playerImage" [alt]="p.playerName" loading="lazy" />
                  <span class="lvl-chip" title="Nível">LV {{ p.level }}</span>
                </div>
                <div class="player-info">
                  <h3 class="player-name">{{ p.playerName }}</h3>
                  <ul class="stats">
                    <li><span class="stat-label">Idade</span><span class="stat-value">{{ p.age }}</span></li>
                    <li><span class="stat-label">Pontos</span><span class="stat-value">{{ p.totalPoints }}</span></li>
                  </ul>
                </div>
              </article>
            }
          }
        </div>
      }
    }

    <!-- Summary when both teams are complete -->
    @if (allSelected()) {
      <section class="summary">
        <h3>Resumo dos Times</h3>
        <div class="teams-summary">
          <div class="team-summary">
            <h4>Time A</h4>
            <ul>
              @for (p of teamA(); track $index) {
                <li>{{ p.playerName }} · LV {{ p.level }} · {{ p.totalPoints }} pts</li>
              }
            </ul>
          </div>
          <div class="team-summary">
            <h4>Time B</h4>
            <ul>
              @for (p of teamB(); track $index) {
                <li>{{ p.playerName }} · LV {{ p.level }} · {{ p.totalPoints }} pts</li>
              }
            </ul>
          </div>
        </div>
        <div class="actions">
          <button class="reset-btn" type="button" (click)="resetSelection()">Refazer seleção</button>
          <button class="start-btn" type="button" (click)="startGame()">Iniciar Jogo</button>
        </div>
      </section>
    }
  }

  <!-- TELA DE PARTIDA -->
  @if (gameStarted()) {
    <section class="game-screen">
      <h2 class="game-title">Arena Match • {{ communityName() || ('Comunidade #' + communityId()) }}</h2><br/>
      <header class="game-header">
        @if (winner() === null) {
          <div class="timer">
            <button class="pause-btn control-btn" type="button" (click)="toggleNarrator()" [attr.aria-label]="narratorOn() ? 'Mutar narrador' : 'Ativar narrador'" [title]="narratorOn() ? 'Mutar narrador' : 'Ativar narrador'">
              @if (narratorOn()) {
                <span class="btn-icon" aria-hidden="true">
                  <!-- volume on icon -->
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 10v4a1 1 0 0 0 1 1h3l3.5 3.5A1 1 0 0 0 12 18V6a1 1 0 0 0-1.5-.86L7 8H4a1 1 0 0 0-1 1z"/><path d="M16.5 8.12a1 1 0 1 0-1.4 1.43A3 3 0 0 1 16 12a3 3 0 0 1-.9 2.12 1 1 0 1 0 1.4 1.43A5 5 0 0 0 18 12a5 5 0 0 0-1.5-3.88z"/><path d="M19.07 5.64a1 1 0 0 0-1.41 1.42A7.96 7.96 0 0 1 20 12a8 8 0 0 1-2.34 5.66 1 1 0 1 0 1.41 1.42A9.96 9.96 0 0 0 22 12c0-2.76-1.12-5.26-2.93-7.36z"/></svg>
                </span>
                <span class="btn-label">Narrador ligado</span>
              } @else {
                <span class="btn-icon" aria-hidden="true">
                  <!-- volume off icon -->
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M16.5 12a3 3 0 0 0-.88-2.12 1 1 0 0 1 1.4-1.43A5 5 0 0 1 18 12a4.97 4.97 0 0 1-1.03 3.02l-1.43-1.43c.61-.7.96-1.6.96-2.59z"/><path d="M3 10v4a1 1 0 0 0 1 1h3l3.5 3.5A1 1 0 0 0 12 18V6a1 1 0 0 0-1.5-.86L7 8H4a1 1 0 0 0-1 1z"/><path d="M20.3 18.3a1 1 0 1 0 1.4-1.4l-16-16a1 1 0 1 0-1.4 1.4l3.26 3.26L20.3 18.3z"/></svg>
                </span>
                <span class="btn-label">Ativar narrador</span>
              }
            </button>
            @if (narratorOn()) {
              <button class="pause-btn control-btn" type="button" (click)="speakCurrentScore()" aria-label="Falar placar" title="Falar placar">
                <span class="btn-icon" aria-hidden="true">
                  <!-- megaphone icon -->
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 10v4a1 1 0 0 0 1 1h2.18l2.4 4.8A1 1 0 0 0 9.5 21H11a1 1 0 0 0 1-1v-4.28l6.66-2.66A2 2 0 0 0 20 11V8a2 2 0 0 0-1.34-1.88L12 3H9.5a1 1 0 0 0-.92.61L6.18 8H4a1 1 0 0 0-1 1zm5.24 6L6.62 13H8v3h.24zM18 9.53v1.94L12 14V7l6 2.53z"/></svg>
                </span>
                <span class="btn-label">Falar placar</span>
              </button>
            }
            <button class="pause-btn control-btn" type="button" (click)="toggleTimer()" [attr.aria-label]="running() ? 'Pausar cronômetro' : 'Continuar cronômetro'" [title]="running() ? 'Pausar cronômetro' : 'Continuar cronômetro'">
              @if (running()) {
                <span class="btn-icon" aria-hidden="true">
                  <!-- pause icon -->
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
                </span>
                <span class="btn-label">Pausar</span>
              } @else {
                <span class="btn-icon" aria-hidden="true">
                  <!-- play icon -->
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </span>
                <span class="btn-label">Continuar</span>
              }
            </button>
          </div>
        }
      </header>

      <!-- Jumbotron NBA-style scoreboard -->
      <div class="jumbotron" [class.pulse-a]="scoreboardPulse() && lastScoredTeam() === 'A'" [class.pulse-b]="scoreboardPulse() && lastScoredTeam() === 'B'" role="region" aria-live="polite" aria-label="Placar do jogo">
        <div class="team-panel left">
          <div class="team-name">
            <span class="name">Time A</span>
            <span class="color-bar a" aria-hidden="true"></span>
          </div>
          <div class="team-score" aria-label="Placar Time A">{{ scoreA() }}</div>
        </div>
        <div class="center-panel">
          <div class="arena-brand" aria-hidden="true">TEMPO</div>
          <div class="center-time">{{ formatTime(timeLeft()) }}</div>
        </div>
        <div class="team-panel right">
          <div class="team-name">
            <span class="name">Time B</span>
            <span class="color-bar b" aria-hidden="true"></span>
          </div>
          <div class="team-score" aria-label="Placar Time B">{{ scoreB() }}</div>
        </div>

        <!-- Confetti burst -->
        @if (confettiSide() === 'A') { <div class="confetti confetti-left" aria-hidden="true"></div> }
        @if (confettiSide() === 'B') { <div class="confetti confetti-right" aria-hidden="true"></div> }
      </div>

      <!-- Mobile Tabs for team columns -->
      <nav class="mobile-tabs" role="tablist" aria-label="Alternar times">
        <button role="tab" [attr.aria-selected]="mobileTab() === 'A'" (click)="mobileTab.set('A')" class="tab" [class.active]="mobileTab() === 'A'">Time A</button>
        <button role="tab" [attr.aria-selected]="mobileTab() === 'B'" (click)="mobileTab.set('B')" class="tab" [class.active]="mobileTab() === 'B'">Time B</button>
      </nav>

      <div class="players-columns" [attr.data-tab]="mobileTab()">
        <app-team-players-column
          class="col-a"
          title="Jogadores A"
          [teamId]="'A'"
          [players]="teamA()"
          [points]="playerPointsRecord()"
          [topNames]="topNamesSet()"
          [bottomNames]="bottomNamesSet()"
          [disabled]="winner() !== null"
          (adjust)="openAdjustPoints($event.team, $event.player, $event.points)"
        />
        <app-team-players-column
          class="col-b"
          title="Jogadores B"
          [teamId]="'B'"
          [players]="teamB()"
          [points]="playerPointsRecord()"
          [topNames]="topNamesSet()"
          [bottomNames]="bottomNamesSet()"
          [disabled]="winner() !== null"
          (adjust)="openAdjustPoints($event.team, $event.player, $event.points)"
        />
      </div>

      @if (winner() !== null) {
        <div class="game-result">
          @if (winner() === 'Empate') {
            <p>Fim de jogo: Empate!</p>
          } @else {
            <p>Fim de jogo: Time {{ winner() }} venceu!</p>
          }
        </div>
        <div class="end-actions">
          <button class="stats-btn" type="button" (click)="openStats()">Ver Estatísticas</button>
          <button class="reset-btn" type="button" (click)="resetSelection()">Nova Partida</button>
        </div>
      }

      <!-- Modal Estatísticas -->
      @if (statsOpen()) {
        <div class="modal-overlay" (click)="closeStats()">
          <div class="modal-card stats-modal" (click)="$event.stopPropagation()">
            <h3>Estatísticas da Partida</h3>
            <ul class="stat-list">
              <li>
                <strong>MVP:</strong>
                @if (mvpPlayer()) { {{ mvpPlayer()!.playerName }} · {{ getPlayerMatchPoints(mvpPlayer()!) }} pts } @else { — }
              </li>
              <li>
                <strong>Maior Pontuador:</strong>
                @if (topScorerPlayer()) { {{ topScorerPlayer()!.playerName }} · {{ getPlayerMatchPoints(topScorerPlayer()!) }} pts } @else { — }
              </li>
            </ul>

            @if (bestPlayer()) {
              <app-card-qualificacao
                [player]="bestPlayer()!"
                [teamPlayers]="teamFor(bestPlayer()!)"
                [pointsRecord]="playerPointsRecord()"
                [animated]="true"
              />
            }
            <h2>MVP</h2>

            <button type="button" class="btn-cancel" (click)="closeStats()">Fechar</button>
          </div>
        </div>
      }

      <!-- Modal para somar/diminuir pontos (componente) -->
      <app-adjust-points-modal
        [open]="modalOpen()"
        [pendingAction]="pendingAction()"
        [isTopScorer]="pendingAction() ? isTopScorer(pendingAction()!.player) : false"
        [isBottomScorer]="pendingAction() ? isBottomScorer(pendingAction()!.player) : false"
        (confirm)="confirmAdjust($event)"
        (cancel)="closeModal()"
      />
    </section>
  }
</section>
